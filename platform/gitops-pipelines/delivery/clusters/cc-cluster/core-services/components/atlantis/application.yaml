apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: atlantis
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: '10'
spec:
  project: core
  source:
    repoURL: https://runatlantis.github.io/helm-charts
    chart: atlantis
    targetRevision: 5.17.2
    helm:
      values: |-
        commonLabels:
          <PLATFORM_NAME_KEBAB>.cost-allocation.cost-center: platform
          <PLATFORM_NAME_KEBAB>.metadata.owner: <GITOPS_REPOSITORY_NAME>-admin
          <PLATFORM_NAME_KEBAB>.metadata.service: atlantis
          <PLATFORM_NAME_KEBAB>.metadata.chart-version: 5.17.2
          <PLATFORM_NAME_KEBAB>.metadata.version: 0.34.0
        statefulSet:
          annotations:
            secret.reloader.stakater.com/reload: "atlantis-envs-secrets"
        atlantisUrl: https://<IAC_PR_AUTOMATION_INGRESS_URL>
        orgAllowlist: <GIT_REPOSITORY_ROOT>/*
        hidePrevPlanComments: true
        serviceAccount:
          create: true
          mount: true
          annotations:
            <K8S_ROLE_MAPPING>: "<IAC_PR_AUTOMATION_IAM_ROLE_RN>"
        podTemplate:
          labels:
            <PLATFORM_NAME_KEBAB>.cost-allocation.cost-center: platform
            <PLATFORM_NAME_KEBAB>.metadata.owner: <GITOPS_REPOSITORY_NAME>-admin
            <PLATFORM_NAME_KEBAB>.metadata.service: atlantis
            <PLATFORM_NAME_KEBAB>.metadata.chart-version: 5.4.2
            <PLATFORM_NAME_KEBAB>.metadata.version: 0.28.5
            # <ADDITIONAL_LABELS>
        resources:
          limits:
            cpu: 400m
            memory: 1Gi
          requests:
            cpu: 400m
            memory: 512Mi
        ingress:
          enabled: true
          annotations:
            alb.ingress.kubernetes.io/scheme: internet-facing
                  alb.ingress.kubernetes.io/success-codes: "200-399"
            alb.ingress.kubernetes.io/certificate-arn: <ACM_CERTIFICATE_ARN>
            alb.ingress.kubernetes.io/group.name: <ALB_INGRESS_GROUP_NAME>
            alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
            alb.ingress.kubernetes.io/security-groups: <ALB_SECURITY_GROUPS>
            alb.ingress.kubernetes.io/subnets: <ALB_PUBLIC_SUBNETS>
            alb.ingress.kubernetes.io/tags: environment=<PRIMARY_CLUSTER_NAME>,provisioned-by=<PLATFORM_NAME_KEBAB>
            alb.ingress.kubernetes.io/target-type: ip
            alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
          path: /
          host: <IAC_PR_AUTOMATION_INGRESS_URL>
          ingressClassName: "alb"
        basicAuthSecretName: atlantis-basic-auth-secrets
        defaultTFVersion: <TERRAFORM_VERSION>
        loadEnvFromSecrets:
          - atlantis-envs-secrets
        repoConfig: |
          ---
          repos:
          - id: <GIT_REPOSITORY_ROOT>/*
            workflow: default
            allowed_overrides: [apply_requirements]
            apply_requirements: [mergeable]
        volumeClaim:
          dataStorage: 20Gi
        imagePullSecrets:
         - docker-config
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: atlantis
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        maxDuration: 5m0s
        factor: 2
